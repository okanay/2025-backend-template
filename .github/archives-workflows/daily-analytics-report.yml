# name: Daily Analytics Report

# on:
#   schedule:
#     - cron: "0 9 * * *" # Her gÃ¼n saat 09:00 (TÃ¼rkiye saati 12:00)
#   workflow_dispatch: # Manuel test iÃ§in

# jobs:
#   generate-report:
#     runs-on: ubuntu-latest

#     steps:
#       - name: Generate Daily Analytics Report
#         uses: appleboy/ssh-action@v0.1.5
#         with:
#           host: ${{ secrets.HOST }}
#           username: ${{ secrets.USERNAME }}
#           key: ${{ secrets.PRIVATE_KEY }}
#           passphrase: ${{ secrets.PASSPHRASE }}
#           port: 22
#           script: |
#             echo "ðŸ“Š Generating Daily Analytics Report - $(date '+%Y-%m-%d')"
#             echo "========================================================"

#             # BugÃ¼nÃ¼n tarihini al
#             TODAY=$(date '+%Y-%m-%d')

#             echo "ðŸ“… Report Date: $TODAY"
#             echo "ðŸ• Report Time: $(date '+%H:%M:%S %Z')"
#             echo ""

#             # 1. GENEL Ä°STATÄ°STÄ°KLER
#             echo "ðŸ“ˆ DAILY STATISTICS"
#             echo "==================="

#             # Toplam request sayÄ±sÄ±
#             TOTAL_REQUESTS=$(sudo journalctl -u backend-template-api --since today --no-pager | grep -c "GET\|POST\|PUT\|DELETE\|PATCH" )
#             echo "ðŸ”¢ Total Requests: $TOTAL_REQUESTS"

#             # GET requests
#             GET_REQUESTS=$(sudo journalctl -u backend-template-api --since today --no-pager | grep -c "GET" )
#             echo "ðŸ” GET Requests: $GET_REQUESTS"

#             # POST requests
#             POST_REQUESTS=$(sudo journalctl -u backend-template-api --since today --no-pager | grep -c "POST" )
#             echo "ðŸ“ POST Requests: $POST_REQUESTS"

#             # PUT/PATCH requests
#             UPDATE_REQUESTS=$(sudo journalctl -u backend-template-api --since today --no-pager | grep -c -E "PUT|PATCH" )
#             echo "âœï¸ Update Requests (PUT/PATCH): $UPDATE_REQUESTS"

#             # DELETE requests
#             DELETE_REQUESTS=$(sudo journalctl -u backend-template-api --since today --no-pager | grep -c "DELETE" )
#             echo "ðŸ—‘ï¸ DELETE Requests: $DELETE_REQUESTS"

#             echo ""

#             # 2. STATUS CODE ANALÄ°ZÄ°
#             echo "ðŸ“Š HTTP STATUS CODES"
#             echo "===================="

#             # 200 (Success)
#             SUCCESS_200=$(sudo journalctl -u backend-template-api --since today --no-pager | grep -c "| 200 |" )
#             echo "âœ… 200 Success: $SUCCESS_200"

#             # 201 (Created)
#             CREATED_201=$(sudo journalctl -u backend-template-api --since today --no-pager | grep -c "| 201 |" )
#             echo "ðŸ†• 201 Created: $CREATED_201"

#             # 400 (Bad Request)
#             BAD_REQUEST_400=$(sudo journalctl -u backend-template-api --since today --no-pager | grep -c "| 400 |" )
#             echo "âš ï¸ 400 Bad Request: $BAD_REQUEST_400"

#             # 401 (Unauthorized)
#             UNAUTHORIZED_401=$(sudo journalctl -u backend-template-api --since today --no-pager | grep -c "| 401 |" )
#             echo "ðŸ”’ 401 Unauthorized: $UNAUTHORIZED_401"

#             # 404 (Not Found)
#             NOT_FOUND_404=$(sudo journalctl -u backend-template-api --since today --no-pager | grep -c "| 404 |" )
#             echo "âŒ 404 Not Found: $NOT_FOUND_404"

#             # 500 (Server Error)
#             SERVER_ERROR_500=$(sudo journalctl -u backend-template-api --since today --no-pager | grep -c "| 500 |" )
#             echo "ðŸš¨ 500 Server Error: $SERVER_ERROR_500"

#             echo ""

#             # 3. EN POPÃœLER ENDPOINT'LER
#             echo "ðŸ”¥ TOP ENDPOINTS (Today)"
#             echo "========================"

#             # GET endpoints (top 10)
#             sudo journalctl -u backend-template-api --since today --no-pager | \
#             grep "GET" | \
#             grep -o "GET[[:space:]]*[^[:space:]]*" | \
#             sort | uniq -c | sort -rn | head -10 | \
#             while read count endpoint; do
#                 echo "ðŸ“ $endpoint: $count requests"
#             done

#             echo ""
#             # 4. IP ADRESLERÄ° (Unique visitors)
#             echo "ðŸ‘¥ IP ADDRESSES"
#             echo "======================"

#             # Unique IP sayÄ±sÄ±nÄ± bul
#             UNIQUE_IPS=$(sudo journalctl -u backend-template-api --since today --no-pager | \
#                 grep -oE "[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+" | \
#                 sort -u | wc -l)
#             echo "ðŸŒ Unique IP Addresses: $UNIQUE_IPS"

#             # En Ã§ok istek atan ilk 5 IP adresini gÃ¶ster
#             echo ""
#             echo "ðŸ” TOP 5 IP ADDRESSES:"
#             sudo journalctl -u backend-template-api --since today --no-pager | \
#                 grep -oE "[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+" | \
#                 sort | uniq -c | sort -rn | head -5 | \
#                 awk '{printf "ðŸ  %s: %s requests\n", $2, $1}'

#             echo ""

#             # 5. RESPONSE TIME ANALYSIS (Gin log formatÄ±na gÃ¶re dÃ¼zeltildi)
#             echo "â±ï¸  RESPONSE TIME ANALYSIS"
#             echo "========================="

#             # Microsecond responses (Âµs)
#             MICRO_RESPONSES=$(sudo journalctl -u backend-template-api --since today --no-pager | grep -c "Âµs |" )
#             # Millisecond responses (ms)
#             MS_RESPONSES=$(sudo journalctl -u backend-template-api --since today --no-pager | grep -c "ms |" )
#             # Second responses (s) - eÄŸer varsa
#             SEC_RESPONSES=$(sudo journalctl -u backend-template-api --since today --no-pager | grep -c -E "[0-9]+s \|" )

#             echo "Microsecond responses (Âµs): $MICRO_RESPONSES âš¡"
#             echo "Millisecond responses (ms): $MS_RESPONSES ðŸƒ"
#             echo "Second responses (s): $SEC_RESPONSES ðŸŒ"

#             # Average response time hesapla (sadece ms'larÄ± al)
#             echo ""
#             echo "ðŸ“Š Response Time Details:"

#             # TÃ¼m ms cinsinden response sÃ¼relerini al ve average hesapla
#             RESPONSE_TIMES=$(sudo journalctl -u backend-template-api --since today --no-pager | grep "ms |" | grep -o "[0-9]\+\.[0-9]\+ms" | sed 's/ms//g')
#             if [ -n "$RESPONSE_TIMES" ]; then
#                 TOTAL=0
#                 COUNT=0
#                 for t in $RESPONSE_TIMES; do
#                     TOTAL=$(echo "$TOTAL + $t" | bc)
#                     COUNT=$((COUNT + 1))
#                 done
#                 if [ "$COUNT" -gt 0 ]; then
#                     AVG=$(echo "scale=2; $TOTAL / $COUNT" | bc)
#                     echo "   ðŸ“ˆ Average Response Time (ms): $AVG"
#                 else
#                     echo "   ðŸ“ˆ Average Response Time (ms): N/A"
#                 fi
#             else
#                 echo "   ðŸ“ˆ Average Response Time (ms): N/A"
#             fi

#             # Ã–rnek response sÃ¼releri (ilk 10)
#             sudo journalctl -u backend-template-api --since today --no-pager | \
#             grep "ms |" | \
#             grep -o "[0-9]\+\.[0-9]\+ms" | \
#             head -10 | \
#             while read response_time; do
#                 echo "   â° Sample: $response_time"
#             done

#             echo ""

#             # 6. ERROR LOGS
#             echo "ðŸš¨ ERROR ANALYSIS"
#             echo "================="

#             # Gin errors
#             ERROR_COUNT=$(sudo journalctl -u backend-template-api --since today --no-pager | grep -c -i "error" )
#             echo "âŒ Total Errors: $ERROR_COUNT"

#             # Panic logs
#             PANIC_COUNT=$(sudo journalctl -u backend-template-api --since today --no-pager | grep -c -i "panic" )
#             echo "ðŸ’¥ Panic Count: $PANIC_COUNT"

#             if [ "$ERROR_COUNT" -gt 0 ]; then
#                 echo ""
#                 echo "ðŸ” RECENT ERRORS (Last 5):"
#                 sudo journalctl -u backend-template-api --since today --no-pager | grep -i "error" | tail -5
#             fi

#             echo ""

#             # 7. SISTEM DURUMU
#             echo "ðŸ–¥ï¸  SYSTEM STATUS"
#             echo "================="

#             # Service uptime
#             SERVICE_UPTIME=$(sudo systemctl show backend-template-api --property=ActiveEnterTimestamp | cut -d'=' -f2)
#             echo "ðŸ• Service Started: $SERVICE_UPTIME"

#             # Memory usage (dÃ¼zeltildi)
#             MEMORY_INFO=$(free -h | grep '^Mem:')
#             MEMORY_USED=$(echo "$MEMORY_INFO" | awk '{print $3}')
#             MEMORY_TOTAL=$(echo "$MEMORY_INFO" | awk '{print $2}')
#             # Fix: Only calculate percent if both values are in the same unit (convert to MiB)
#             MEMORY_USED_MIB=$(free -m | awk '/^Mem:/ {print $3}')
#             MEMORY_TOTAL_MIB=$(free -m | awk '/^Mem:/ {print $2}')
#             if [ "$MEMORY_TOTAL_MIB" -gt 0 ] 2>/dev/null; then
#                 MEMORY_PERCENT=$(awk "BEGIN {printf \"%.1f\", ($MEMORY_USED_MIB/$MEMORY_TOTAL_MIB)*100}")
#             else
#                 MEMORY_PERCENT="N/A"
#             fi
#             echo "ðŸ’¾ Memory Usage: $MEMORY_USED/$MEMORY_TOTAL (${MEMORY_PERCENT}%)"

#             # Disk usage
#             DISK_USAGE=$(df -h / | tail -1 | awk '{print $3"/"$2" ("$5")"}')
#             echo "ðŸ’½ Disk Usage: $DISK_USAGE"

#             # CPU load
#             CPU_LOAD=$(uptime | awk -F'load average:' '{print $2}')
#             echo "âš¡ CPU Load:$CPU_LOAD"

#             echo ""
#             echo "ðŸ“Š Report Generated Successfully!"
#             echo "========================================================"
