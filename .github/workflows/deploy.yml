name: Deploy to Production with Zero Downtime

on:
  # Yorum satÄ±rÄ±nÄ± kaldÄ±rÄ±rsanÄ±z, main branch'e push olayÄ± tetiklenir ve yeni kodlarÄ± sunucuya daÄŸÄ±tÄ±r.
  # push:
  # branches: [main]
  workflow_dispatch:

env:
  # --- TEMEL AYARLAR ---
  PROJECT_ROOT: "/root/2025-backend-template"
  PORT_A: 4040
  PORT_B: 4041
  KEEP_RELEASES: 3 # Sunucuda tutulacak eski versiyon sayÄ±sÄ±
  HEALTH_CHECK_PATH: "/" # SaÄŸlÄ±k kontrolÃ¼ iÃ§in endpoint

  # --- PROJEYE Ã–ZEL KOMUTLAR ---
  # Projenizin baÄŸÄ±mlÄ±lÄ±klarÄ±nÄ± kuran komut. Gerekmiyorsa boÅŸ bÄ±rakÄ±n.
  # Ã–rnek Node.js/React: "npm install"
  # Ã–rnek Go: "go mod tidy"
  INSTALL_COMMAND: "go mod tidy"

  # Projenizi build eden/derleyen komut.
  BUILD_COMMAND: "/usr/local/go/bin/go build -o main ."

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Deploy to Server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.PRIVATE_KEY }}
          passphrase: ${{ secrets.PASSPHRASE }}
          port: ${{ secrets.PORT }}
          script: |
            set -e # Herhangi bir komut baÅŸarÄ±sÄ±z olursa script'i anÄ±nda durdur

            # --- 1. DEPLOYMENT ORTAMINI HAZIRLA ---
            RELEASES_DIR="${{ env.PROJECT_ROOT }}/releases"
            STATE_DIR="${{ env.PROJECT_ROOT }}/state"
            RELEASE_ID=$(date +%Y%m%d%H%M%S)
            NEW_RELEASE_DIR="$RELEASES_DIR/$RELEASE_ID"
            LIVE_PORT_FILE="$STATE_DIR/live.port"
            LIVE_PID_FILE="$STATE_DIR/app.pid"
            UPSTREAM_CONF_FILE="/etc/nginx/includes/backend_upstream.conf"

            echo "ðŸš€ Deployment BaÅŸlatÄ±lÄ±yor: Release ID $RELEASE_ID"
            mkdir -p $RELEASES_DIR $STATE_DIR

            # --- 2. YENÄ° VERSÄ°YONU KUR ---
            echo "â¬‡ï¸  Kod yeni release klasÃ¶rÃ¼ne klonlanÄ±yor..."
            git clone https://github.com/${{ github.repository }}.git $NEW_RELEASE_DIR
            cd $NEW_RELEASE_DIR

            echo "ðŸ“‹ Sunucudaki merkezi .env dosyasÄ± bu release'e kopyalanÄ±yor..."
            if [ -f "${{ env.PROJECT_ROOT }}/.env" ]; then
              cp "${{ env.PROJECT_ROOT }}/.env" .
              echo "âœ… .env dosyasÄ± baÅŸarÄ±yla kopyalandÄ±."
            else
              echo "âš ï¸ UYARI: ${env.PROJECT_ROOT}/.env dosyasÄ± bulunamadÄ±."
            fi

            # --- 3. BAÄžIMLILIKLARI YÃœKLE (YENÄ° ADIM) ---
            if [ -n "${{ env.INSTALL_COMMAND }}" ]; then
              echo "ðŸ“¦ BaÄŸÄ±mlÄ±lÄ±klar yÃ¼kleniyor: ${{ env.INSTALL_COMMAND }}"
              ${{ env.INSTALL_COMMAND }}
              echo "âœ… BaÄŸÄ±mlÄ±lÄ±klar yÃ¼klendi."
            else
              echo "â„¹ï¸  Kurulum komutu (INSTALL_COMMAND) tanÄ±mlanmamÄ±ÅŸ, bu adÄ±m atlanÄ±yor."
            fi

            # --- 4. UYGULAMAYI BUILD ET ---
            echo "ðŸ”¨ Uygulama build ediliyor: ${{ env.BUILD_COMMAND }}"
            ${{ env.BUILD_COMMAND }}
            echo "âœ… Build tamamlandÄ±."

            # --- Sonraki adÄ±mlar Ã¶ncekiyle aynÄ±... ---
            if [ -f "$LIVE_PORT_FILE" ]; then
              CURRENT_PORT=$(cat $LIVE_PORT_FILE)
            else
              CURRENT_PORT=""
            fi
            NEW_PORT=$([ "$CURRENT_PORT" = "${{ env.PORT_A }}" ] && echo "${{ env.PORT_B }}" || echo "${{ env.PORT_A }}")
            echo "ðŸ”„ Port DeÄŸiÅŸimi: Mevcut: '$CURRENT_PORT' -> Yeni Hedef: '$NEW_PORT'"

            echo "ðŸ©º Yeni versiyon $NEW_PORT portunda baÅŸlatÄ±lÄ±yor..."
            (PORT=$NEW_PORT nohup ./main &> app.log & echo $! > ./app.pid.temp)
            sleep 8
            HEALTH_CHECK_URL="http://localhost:$NEW_PORT${{ env.HEALTH_CHECK_PATH }}"
            echo "ðŸ”Ž SaÄŸlÄ±k kontrolÃ¼ yapÄ±lÄ±yor: $HEALTH_CHECK_URL"

            if ! curl -s --fail --retry 3 --retry-delay 5 $HEALTH_CHECK_URL; then
              echo "âŒ SaÄŸlÄ±k kontrolÃ¼ BAÅžARISIZ! Deployment geri alÄ±nÄ±yor."
              echo "--- UYGULAMA LOGLARI (app.log) ---"; cat app.log; echo "---"
              NEW_PID=$(cat ./app.pid.temp); if [ -n "$NEW_PID" ]; then kill $NEW_PID || true; fi
              rm -rf $NEW_RELEASE_DIR
              exit 1
            fi
            echo "âœ… SaÄŸlÄ±k kontrolÃ¼ BAÅžARILI."

            echo "ðŸ”„ Nginx yeni porta yÃ¶nlendiriliyor..."
            echo "server 127.0.0.1:$NEW_PORT;" | sudo tee $UPSTREAM_CONF_FILE
            sudo nginx -s reload
            echo "âœ… Nginx baÅŸarÄ±yla $NEW_PORT portuna yÃ¶nlendirildi."

            echo "â³ Eski sÃ¼reci sonlandÄ±rmadan Ã¶nce 1 saniye bekleniyor..."
            sleep 1

            if [ -f "$LIVE_PID_FILE" ]; then
              OLD_PID=$(cat $LIVE_PID_FILE)
              echo "ðŸ›‘ Eski versiyon (PID: $OLD_PID, Port: $CURRENT_PORT) durduruluyor..."
              if ps -p $OLD_PID > /dev/null; then kill $OLD_PID; echo "âœ… Eski sÃ¼reÃ§ durduruldu."; else echo "â„¹ï¸ Eski PID ($OLD_PID) zaten Ã§alÄ±ÅŸmÄ±yor."; fi
            else
              echo "â„¹ï¸ Durdurulacak eski bir sÃ¼reÃ§ (PID dosyasÄ±) bulunamadÄ±."
            fi

            echo $NEW_PORT > $LIVE_PORT_FILE
            mv ./app.pid.temp $LIVE_PID_FILE

            echo "ðŸ§¹ Eski versiyonlar temizleniyor..."
            cd $RELEASES_DIR && ls -1tr | head -n -${{ env.KEEP_RELEASES }} | xargs -r rm -rf

            echo "ðŸŽ‰ Deployment baÅŸarÄ±yla tamamlandÄ±! Aktif Port: $NEW_PORT"
