name: Deploy to Production with Zero Downtime

on:
  push:
    branches: [main]
  workflow_dispatch:

env:
  PROJECT_DIR: "/root/2025-backend-template"
  # UygulamanÄ±n Ã§alÄ±ÅŸabileceÄŸi portlar
  PORT_A: 4040
  PORT_B: 4041
  # Sunucuda kaÃ§ eski versiyonun tutulacaÄŸÄ±
  KEEP_RELEASES: 5
  # UygulamanÄ±zÄ±n saÄŸlÄ±k kontrolÃ¼ iÃ§in endpoint'i
  HEALTH_CHECK_PATH: "/"
  # Go build komutu
  BUILD_COMMAND: "/usr/local/go/bin/go build -o main ."

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Deploy to Server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.PRIVATE_KEY }}
          passphrase: ${{ secrets.PASSPHRASE }}
          port: ${{ secrets.PORT }}
          script: |
            set -e # Herhangi bir komut baÅŸarÄ±sÄ±z olursa script'i durdur

            # --- DEPLOYMENT DEÄÄ°ÅKENLERÄ°NÄ° AYARLA ---
            RELEASES_DIR="${{ env.PROJECT_DIR }}/releases"
            STATE_DIR="${{ env.PROJECT_DIR }}/state" # CanlÄ± port ve PID gibi durum bilgileri iÃ§in
            RELEASE_ID=$(date +%Y%m%d%H%M%S)
            RELEASE_DIR="$RELEASES_DIR/$RELEASE_ID"
            LIVE_PORT_FILE="$STATE_DIR/live.port"
            PID_FILE_PATH="$STATE_DIR/app.pid"

            echo "ğŸš€ Deployment BaÅŸlatÄ±lÄ±yor: Release ID $RELEASE_ID"

            # Gerekli klasÃ¶rleri oluÅŸtur
            mkdir -p $RELEASES_DIR
            mkdir -p $STATE_DIR

            # --- 1. YENÄ° VERSÄ°YONU HAZIRLA VE BUILD ET ---
            echo "â¬‡ï¸  Kod KlonlanÄ±yor ve Build Ediliyor..."
            git clone https://github.com/${{ github.repository }}.git $RELEASE_DIR
            cd $RELEASE_DIR
            # .env dosyasÄ±nÄ± bir Ã¶nceki versiyondan kopyala (varsa)
            if [ -f "${{ env.PROJECT_DIR }}/.env" ]; then
              cp "${{ env.PROJECT_DIR }}/.env" .
            fi
            ${{ env.BUILD_COMMAND }}
            echo "âœ… Build tamamlandÄ±."

            # --- 2. YENÄ° PORTU BELÄ°RLE ---
            # Mevcut canlÄ± portu oku, dosya yoksa varsayÄ±lan olarak PORT_A'yÄ± kullan
            CURRENT_PORT=$(cat $LIVE_PORT_FILE || echo "${{ env.PORT_A }}")

            if [ "$CURRENT_PORT" = "${{ env.PORT_A }}" ]; then
              NEW_PORT=${{ env.PORT_B }}
            else
              NEW_PORT=${{ env.PORT_A }}
            fi
            echo "ğŸ”„ Port DeÄŸiÅŸimi: Mevcut Port: $CURRENT_PORT -> Yeni Port: $NEW_PORT"

            # --- 3. YENÄ° UYGULAMAYI BAÅLAT VE TEST ET ---
            echo "ğŸ©º Yeni versiyon $NEW_PORT portunda saÄŸlÄ±k kontrolÃ¼ iÃ§in baÅŸlatÄ±lÄ±yor..."
            # Komut: PORT'u ver, .env'deki diÄŸer deÄŸiÅŸkenleri yÃ¼kle ve uygulamayÄ± arkaplanda baÅŸlat
            (cd $RELEASE_DIR && PORT=$NEW_PORT nohup ./main &> app.log & echo $! > $PID_FILE_PATH)

            # UygulamanÄ±n baÅŸlamasÄ± iÃ§in bekle
            sleep 10

            HEALTH_CHECK_URL="http://localhost:$NEW_PORT${{ env.HEALTH_CHECK_PATH }}"
            echo "ğŸ” SaÄŸlÄ±k kontrolÃ¼ yapÄ±lÄ±yor: $HEALTH_CHECK_URL"

            if ! curl -s --fail --retry 5 --retry-delay 3 $HEALTH_CHECK_URL; then
              echo "âŒ SaÄŸlÄ±k kontrolÃ¼ BAÅARISIZ! Deployment geri alÄ±nÄ±yor."
              NEW_PID=$(cat $PID_FILE_PATH)
              kill $NEW_PID
              rm -rf $RELEASE_DIR
              exit 1
            fi
            echo "âœ… SaÄŸlÄ±k kontrolÃ¼ BAÅARILI."

            # --- 4. NGINX'Ä° YENÄ° PORTA YÃ–NLENDÄ°R (SOFT SWITCH) ---
            echo "ğŸ”„ Nginx yeni porta yÃ¶nlendiriliyor..."
            echo "server 127.0.0.1:$NEW_PORT;" | sudo tee /etc/nginx/conf.d/backend_upstream.conf
            sudo nginx -s reload # BaÄŸlantÄ±larÄ± kesmeden yeniden yÃ¼kle
            echo "âœ… Nginx baÅŸarÄ±yla $NEW_PORT portuna yÃ¶nlendirildi."

            # --- 5. ESKÄ° UYGULAMAYI DURDUR ---
            # Eski PID'yi bul ve iÅŸlemi sonlandÄ±r
            OLD_PID=$(ps aux | grep "[p]ort $CURRENT_PORT" | grep main | awk '{print $2}')
            if [ -n "$OLD_PID" ]; then
              echo "ğŸ›‘ Eski versiyon (PID: $OLD_PID, Port: $CURRENT_PORT) durduruluyor..."
              kill $OLD_PID
            else
              echo "â„¹ï¸  Eski versiyon zaten Ã§alÄ±ÅŸmÄ±yor."
            fi

            # --- 6. DURUMU GÃœNCELLE VE TEMÄ°ZLÄ°K YAP ---
            # CanlÄ± port bilgisini gÃ¼ncelle
            echo $NEW_PORT > $LIVE_PORT_FILE

            # Yeni PID dosyasÄ±nÄ± kalÄ±cÄ± hale getir
            mv $RELEASE_DIR/$PID_FILE_PATH $STATE_DIR/

            echo "ğŸ§¹ Eski versiyonlar temizleniyor..."
            cd $RELEASES_DIR && ls -1tr | head -n -${{ env.KEEP_RELEASES }} | xargs -r rm -rf

            echo "ğŸ‰ Deployment baÅŸarÄ±yla tamamlandÄ±! CanlÄ± port: $NEW_PORT"
